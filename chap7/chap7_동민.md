# 7. 대역

## 대역의 필요성

- 테스트 대상에서 파일 시스템 사용
- 테스트 대상에서 DB로부터 데이터를 조회하거나 데이터를 추가
- 테스트 대상에서 외부의 HTTP 서버와 통신

테스트 대상이 이런 외부 요인에 의존하면 테스트를 작성하고 실행하기 어려워진다.

- 외부 API가 일시적으로 장애가 나면 테스트를 원활하게 수행할 수 없다.
- 내부 DB라도 상황에 맞게 데이터를 구성하는 것이 항상 가능한 것은 아니다.

이렇게 테스트 대상에서 의존하는 요인 때문에 테스트가 어려울 때는 대역을 써서 테스트를 진행 할 수 있다.

→ 난이도가 높은 액션이 필요할 때 배우를 대신해서 연기하는 스턴트맨처럼 테스트에서는 외부 요인으로 인해 테스트가 어려울 때 외부 요인을 대신하는 대역이 외부 요인을 대신해서 테스트에 참여한다.

## 대역의 종류

- 스텀(stub)
    - 구현을 단순한 것으로 대체한다.
    - 테스트에 맞게 단순히 원하는 동작을 수행한다.
- 가짜(Fake)
    - 제품에는 적합하지 않지만, 실제 동작하는 구현을 제공한다.
    - DB 대신에 메모리를 이용해서 구현한 Memory**Repository가 가짜 대역에 해당한다.
- 스파이(Spy)
    - 호출된 내역을 기록한다, 기록한 내용은 테스트 결과를 검증할 때 사용한다.
    - 스텁이기도 하다.
- 모의(Mock)
    - 기대한 대로 상호작용하는지 행위를 검증한다. 기대한 대로 동작하지 않으면 익셉션을 발생할 수 있다.
    - 모의 객체는 스텁이자 스파이도 된다.

## 대역과 개발 속도

TDD 과정에서 대역을 사용하지 않고 실제 구현을 사용한다면 다음과 같은 일이 벌어지게 된다.

- 카드 정보 제공 업체에서 도난 카드번호를 받을 때까지 테스트를 기다린다.
- 카드 정보 제공 API가 비정상 응답을 주는 상황을 테스트하기 위해 업체의 변경 대응을 기다린다.
- 회원 가입 테스트를 한 뒤에 편지가 도착할 때까지 메일함을 확인한다.
- 약한 암호 검사 기능을 개발할 때까지 회원 가입 테스트를 대기한다.

네 가지 경우 모두 대기 시간이 발생한다. 하지만 대역을 사용한다면 아래와 같은 장점을 가진다.

- 대역을 사용하면 실제 구현이 없어도 다양한 상황에 대해 테스트할 수 있다.
- 외부의 카드 정보 제공 API와 연동할 수 없는 경우에도 테스트할 수 있다.
- 실제 구현 없어도 실행 결과를 확인할 수 있다.
- DB가 없어도 회원 데이터가 올바르게 저장되는지 확인할 수 있고 메일 서버가 없어도 이메일 발송 요청을 하는지 확인할 수 있다.

즉, 대역은 의존하는 대상을 구현하지 않아도 테스트 대상을 완성할 수 있게 만들어주며 이는 대기 시간을 줄여주어 개발 속도를 올리는 데 도움이 된다.

## 모의 객체를 과하게 사용하지 않기

- 모의 객체는 스텁과 스파이를 지원하므로 대역으로 모의 객체를 많이 사용한다.
- 하지만 모의객체를 과하게 사용하면 오히려 테스트 코드가 복잡해지는 경우도 발생한다.

모의 객체를 이용하면 대역 클래스를 만들지 않아도 되니까 편할 수 있다. 하지만 결과 값을 확인하는 수단으로 모의 객체를 사용하기 시작하면 결과 검증 코드가 길어지고 복잡해진다.

- 하나의 테스트를 위해 여러 모의 객체를 사용하기 시작하면 결과 검증 코드의 복잡도는 배로 증가한다.
- 모의 객체는 기본적으로 메서드 호출 여부를 검증하는 수단이기 때문에 테스트 대상과 모의 객체 간의 상호 작용이 조금만 바뀌어도 테스트가 깨지기 쉽다.

특히 DAO나 리포지토리와 같이 저장소에 대한 대역은 모의 객체를 사용하는 것보다 메모리를 이용한 가짜 구현을 사용하는 것이 테스트 코드 관리에 유리하다.